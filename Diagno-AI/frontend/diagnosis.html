<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnosis - AI Health Diagnostic</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* Harmonize category buttons: neutral base, green on hover */
        #categoryModal .category-actions button {
            background: #ffffff;
            color: var(--dark);
            border: 1px solid var(--primary-color);
            transition: all 0.2s ease;
        }

        #categoryModal .category-actions button:hover {
            background: var(--primary-color);
            color: #ffffff;
        }
    </style>
</head>

<body>
    <header>
        <nav>
            <div class="logo">
                <div class="logo-with-img">
                    <img src="assets/img/brand-logo.svg" alt="AI Health Diagnostic" class="site-logo-img"
                        onerror="this.style.display='none'" />
                </div>
                <span>AI Health Diagnostic</span>
            </div>
            <ul class="nav-links">
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="diagnosis.html" class="active">Diagnosis</a></li>
            </ul>
            <div id="userInfo"></div>
        </nav>
    </header>

    <div class="container">
        <div id="categoryModal" style="display:none">
            <div class="category-card">
                <h2>Select Condition Type</h2>
                <p>Please choose which group applies to you</p>
                <div class="category-actions">
                    <button class="btn btn-primary" onclick="selectCategory('acute')">1. Acute Care Conditions</button>
                    <button class="btn btn-secondary" onclick="selectCategory('chronic')">2. Chronic Health
                        Disorders</button>
                </div>
            </div>
        </div>

        <div class="hero" style="padding: 2rem;">
            <h1>üî¨ AI Health Diagnostic</h1>
            <p>Select your symptoms and let AI analyze your condition</p>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>üìù Symptom Selection</h2>
                <p style="color: var(--gray); margin-top: 0.5rem;">
                    Select all symptoms you are currently experiencing. More symptoms = better accuracy
                </p>
            </div>
            <div class="card-body">
                <!-- Search Bar -->
                <div class="form-group">
                    <label for="symptomSearch">üîç Search Symptoms</label>
                    <input type="text" id="symptomSearch" class="form-control" placeholder="Type to search symptoms..."
                        onkeyup="filterSymptoms()">
                </div>

                <!-- Voice Input Button -->
                <div style="text-align: center; margin: 1.5rem 0;">
                    <button onclick="startVoice()" class="btn btn-secondary">
                        üé§ Use Voice Input
                    </button>
                    <p style="color: var(--gray); font-size: 0.9rem; margin-top: 0.5rem;">
                        Say your symptoms and we'll select them for you
                    </p>
                </div>

                <!-- Selected Count -->
                <div class="alert alert-info">
                    <strong>Selected Symptoms:</strong> <span id="selectedCount">0</span>
                    <button onclick="clearSelection()" class="btn btn-danger"
                        style="float: right; padding: 0.3rem 1rem;">
                        Clear All
                    </button>
                </div>

                <!-- Symptoms Checkbox Grid -->
                <div id="symptomsContainer" class="checkbox-grid">
                    <div class="spinner"></div>
                </div>

                <!-- Submit Button -->
                <div style="text-align: center; margin-top: 2rem;">
                    <button onclick="submitDiagnosis()" id="submitBtn" class="btn btn-primary"
                        style="font-size: 1.1rem; padding: 1rem 3rem;" disabled>
                        üîç Analyze Symptoms & Predict Disease
                    </button>
                </div>
            </div>
        </div>

        <!-- Result Container -->
        <div id="resultContainer"></div>

        <!-- Information -->
        <div class="alert alert-warning" style="margin-top: 2rem;">
            <strong>‚ö†Ô∏è Important:</strong>
            <span>
                This AI prediction is for informational purposes only. Please consult with a healthcare
                professional for proper diagnosis and treatment.
            </span>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 AI Health Diagnostic - AI Health Diagnosis System</p>
    </footer>

    <script src="assets/js/app.js"></script>
    <script>
        let allSymptoms = [];
        let selectedSymptoms = [];
        let selectedCategory = null; // 'acute' | 'chronic'

        // Load symptoms (default) but if category selected, fetch mapping and filter
        async function loadSymptoms() {
            // If category selected and mapping available, get mapping from backend
            if (selectedCategory) {
                const mapRes = await apiRequest('/get-disease-symptoms');
                if (mapRes.success) {
                    const mapping = mapRes.mapping || {};
                    // Chronic disease names to include (indices 10,11,12,17)
                    const chronicNames = ['Tuberculosis', 'Diabetes', 'Hypertension', 'Kidney Stones'];

                    let allowedSymptoms = new Set();
                    if (selectedCategory === 'chronic') {
                        chronicNames.forEach(d => {
                            const arr = mapping[d] || [];
                            arr.forEach(s => allowedSymptoms.add(s));
                        });
                    } else {
                        // acute: include all diseases except the chronic ones
                        Object.keys(mapping).forEach(d => {
                            if (!chronicNames.includes(d)) {
                                (mapping[d] || []).forEach(s => allowedSymptoms.add(s));
                            }
                        });
                    }

                    allSymptoms = Array.from(allowedSymptoms).sort();
                    displaySymptoms(allSymptoms);
                    return;
                }
            }

            // Fallback: fetch all symptoms
            const result = await apiRequest('/get-symptoms');
            if (result.success) {
                allSymptoms = result.symptoms;
                displaySymptoms(allSymptoms);
            }
        }

        // Display symptoms
        function displaySymptoms(symptoms) {
            const container = document.getElementById('symptomsContainer');
            let html = '';

            symptoms.forEach(symptom => {
                const isChecked = selectedSymptoms.includes(symptom) ? 'checked' : '';
                const formatted = formatSymptomName(symptom);
                html += `
                    <div class="checkbox-item">
                        <input type="checkbox" id="${symptom}" value="${symptom}" 
                               onchange="toggleSymptom('${symptom}')" ${isChecked}>
                        <label for="${symptom}">${formatted}</label>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Toggle symptom selection
        function toggleSymptom(symptom) {
            if (selectedSymptoms.includes(symptom)) {
                selectedSymptoms = selectedSymptoms.filter(s => s !== symptom);
            } else {
                selectedSymptoms.push(symptom);
            }
            updateSelectedCount();
        }

        // Update selected count
        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedSymptoms.length;
            document.getElementById('submitBtn').disabled = selectedSymptoms.length === 0;
        }

        // Filter symptoms
        function filterSymptoms() {
            const query = document.getElementById('symptomSearch').value.toLowerCase();
            if (query === '') {
                displaySymptoms(allSymptoms);
            } else {
                const filtered = allSymptoms.filter(symptom =>
                    symptom.toLowerCase().includes(query) ||
                    formatSymptomName(symptom).toLowerCase().includes(query)
                );
                displaySymptoms(filtered);
            }
        }

        // Clear selection
        function clearSelection() {
            if (confirm('Clear all selected symptoms?')) {
                selectedSymptoms = [];
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                updateSelectedCount();
            }
        }

        // Voice input
        function startVoice() {
            const recognition = startVoiceRecognition((transcript) => {
                const words = transcript.toLowerCase().split(/[\s,]+/);
                words.forEach(word => {
                    allSymptoms.forEach(symptom => {
                        if (symptom.includes(word) && !selectedSymptoms.includes(symptom)) {
                            selectedSymptoms.push(symptom);
                            document.getElementById(symptom).checked = true;
                        }
                    });
                });
                updateSelectedCount();
                showAlert('Symptoms detected: ' + transcript, 'success');
            });
        }

        // Submit diagnosis
        async function submitDiagnosis() {
            if (selectedSymptoms.length === 0) {
                showAlert('Please select at least one symptom', 'error');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'üîÑ Analyzing...';

            const result = await apiRequest('/predict', 'POST', {
                symptoms: selectedSymptoms
            });

            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;

            if (result.success) {
                displayResult(result);

                // Save report
                if (isAuthenticated()) {
                    await apiRequest('/save-report', 'POST', {
                        prediction: result.primary_prediction.disease,
                        symptoms: selectedSymptoms,
                        confidence: result.primary_prediction.confidence
                    }, true);
                }
            } else {
                showAlert('Error: ' + result.message, 'error');
            }
        }

        // Display result
        function displayResult(result) {
            const container = document.getElementById('resultContainer');
            const primary = result.primary_prediction;
            const info = result.disease_info;

            let html = `
                <div class="result-card" style="margin-top: 2rem; animation: fadeIn 0.5s;">
                    <h2 style="text-align: center; margin-bottom: 1.5rem;">üéØ Diagnosis Result</h2>
                    
                    <div style="background: white; color: var(--dark); padding: 2rem; border-radius: 10px;">
                        <h3 style="color: var(--primary-color); font-size: 2rem; margin-bottom: 1rem;">
                            ${primary.disease}
                        </h3>
                        
                        <div class="confidence-meter">
                            <p><strong>Confidence Level:</strong></p>
                            <div class="progress">
                                <div class="progress-bar" style="width: ${primary.confidence}%; background: ${getConfidenceColor(primary.confidence)};">
                                    ${primary.confidence}%
                                </div>
                            </div>
                        </div>

                        ${info.severity ? `
                        <div style="margin-top: 1rem;">
                            <strong>Severity:</strong> 
                            <span class="badge" style="background: ${getSeverityColor(info.severity)}; color: white;">
                                ${info.severity}
                            </span>
                        </div>
                        ` : ''}

                        <div style="margin-top: 1rem;">
                            <strong>Analyzed Symptoms:</strong>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                                ${result.symptoms_analyzed.map(s => `
                                    <span class="badge badge-info">${formatSymptomName(s)}</span>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <div style="background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: 10px; margin-top: 1.5rem;">
                        <h3 style="margin-bottom: 1rem;">üîù Top 3 Possible Diseases</h3>
                        ${result.top_predictions.map((pred, idx) => `
                            <div style="background: white; color: var(--dark); padding: 1rem; border-radius: 8px; margin-bottom: 0.8rem;">
                                <strong style="color: var(--primary-color);">${idx + 1}. ${pred.disease}</strong>
                                <div class="progress" style="margin-top: 0.5rem; height: 20px;">
                                    <div class="progress-bar" style="width: ${pred.confidence}%; background: ${getConfidenceColor(pred.confidence)}; font-size: 0.8rem;">
                                        ${pred.confidence}%
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- PREDICTION PROBABILITY GRAPH -->
                <div class="card" style="margin-top: 2rem;">
                    <div class="card-header">
                        <h2>üìä Disease Probability Analysis</h2>
                        <p style="color: var(--gray); font-size: 0.9rem; margin-top: 0.5rem;">
                            Visual representation of all possible diseases and their prediction percentages
                        </p>
                    </div>
                    <div class="card-body">
                        <div id="predictionChartWrapper" style="height: 360px; position: relative;">
                            <div style="position: absolute; top: 8px; right: 12px; z-index: 5;">
                                <button id="expandChartBtn" class="btn" onclick="expandChart()" title="Expand chart" style="padding: 0.35rem 0.6rem; font-size: 0.9rem;">üîç Expand</button>
                                <button id="collapseChartBtn" class="btn" onclick="collapseChart()" title="Collapse" style="display:none; margin-left:6px; padding: 0.35rem 0.6rem; font-size: 0.9rem;">‚ùé Close</button>
                            </div>
                            <canvas id="predictionChart" style="width:100%; height:100%;"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 2rem;">
                    <div class="card-header">
                        <h2>üìã Medical Information & Recommendations</h2>
                    </div>
                    <div class="card-body disease-recommendations">
                        ${info.description ? `
                        <div class="recommendation-section">
                            <h4>üìñ About ${primary.disease}</h4>
                            <p>${info.description}</p>
                        </div>
                        ` : ''}

                        ${info.prevention && info.prevention.length > 0 ? `
                        <div class="recommendation-section">
                            <h4>üõ°Ô∏è Prevention Tips</h4>
                            <ul>
                                ${info.prevention.map(tip => `<li>${tip}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}

                        ${info.treatment && info.treatment.length > 0 ? `
                        <div class="recommendation-section">
                            <h4>üíä Treatment Recommendations</h4>
                            <ul>
                                ${info.treatment.map(treat => `<li>${treat}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}

                        ${info.medicines && info.medicines.length > 0 ? `
                        <div class="recommendation-section">
                            <h4>üíä Common Medications</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${info.medicines.map(med => `
                                    <span class="badge badge-success">${med}</span>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}

                        ${info.diet && info.diet.length > 0 ? `
                        <div class="recommendation-section">
                            <h4>ü•ó Diet Recommendations</h4>
                            <ul>
                                ${info.diet.map(food => `<li>${food}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}

                        <div class="alert alert-warning" style="margin-top: 1.5rem;">
                            <strong>‚ö†Ô∏è Important Medical Advice:</strong><br>
                            ${info.severity && info.severity.toLowerCase().includes('severe') ?
                    'This is a potentially serious condition. Please seek immediate medical attention from a qualified healthcare provider.' :
                    'While this information is helpful, please consult with a healthcare professional for proper diagnosis and treatment plan.'}
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin: 2rem 0;">
                    <button onclick="exportReport()" class="btn btn-secondary" style="margin-right: 1rem;">
                        üìÑ Export Report
                    </button>
                    <button onclick="location.reload()" class="btn btn-primary">
                        üîÑ New Diagnosis
                    </button>
                    <a href="dashboard.html" class="btn">
                        üìä Go to Dashboard
                    </a>
                </div>
            `;

            container.innerHTML = html;

            // Create the prediction chart after HTML is rendered
            setTimeout(() => createPredictionChart(result.all_predictions), 100);

            container.scrollIntoView({ behavior: 'smooth' });
        }

        // Export report
        function exportReport() {
            exportToPDF('resultContainer', 'ai-health-diagnostic-report');
        }

        // Create Prediction Chart (Top 5 line chart styled like the example image)
        function createPredictionChart(predictions) {
            const canvas = document.getElementById('predictionChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            // Sort predictions by confidence (highest first)
            const sorted = Object.entries(predictions).sort((a, b) => b[1] - a[1]);

            // Take top 5 (best 5 diseases)
            const topPredictions = sorted.slice(0, 5);

            const labels = topPredictions.map(([disease, _]) => disease);
            const data = topPredictions.map(([_, confidence]) => confidence);

            // Point colors: highlight first three
            const pointColors = data.map((conf, idx) => {
                if (idx === 0) return '#0ea5a4'; // Teal for best
                if (idx === 1) return '#06b6d4'; // Light teal
                if (idx === 2) return '#60a5fa'; // Soft blue
                return '#93c5fd'; // lighter blue for others
            });

            // If a previous chart exists on the canvas, destroy it
            if (canvas._chartInstance) {
                canvas._chartInstance.destroy();
            }

            // Use a straight (non-smoothed) line with clear markers to get the up-down shape
            // Dynamically compute Y-axis bounds so small differences show as up/down peaks
            const minVal = Math.min(...data);
            const maxVal = Math.max(...data);
            // Compute padding: if all values very close, add a minimum padding so points are visible
            const range = Math.max(1e-6, maxVal - minVal);
            const padding = Math.max(5, range * 0.6); // at least 5 percentage points or 60% of range
            const suggestedMin = Math.max(0, Math.floor((minVal - padding) / 1));
            const suggestedMax = Math.min(100, Math.ceil((maxVal + padding) / 1));

            // Plugin to draw value labels above each point (small, readable)
            const valueLabelPlugin = {
                id: 'valueLabelPlugin',
                afterDatasetsDraw: function (chartInstance) {
                    const ctx2 = chartInstance.ctx;
                    chartInstance.data.datasets.forEach(function (dataset, dsIndex) {
                        const meta = chartInstance.getDatasetMeta(dsIndex);
                        meta.data.forEach(function (point, index) {
                            const value = dataset.data[index];
                            const x = point.x;
                            const y = point.y - 10;
                            ctx2.save();
                            ctx2.font = '12px Arial';
                            ctx2.fillStyle = '#1f2937';
                            ctx2.textAlign = 'center';
                            ctx2.fillText(value.toFixed(2) + '%', x, y);
                            ctx2.restore();
                        });
                    });
                }
            };

            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Probability (%)',
                        data: data,
                        fill: false,
                        backgroundColor: 'transparent',
                        borderColor: '#0b5ed7',
                        borderWidth: 2.5,
                        tension: 0, // straight segments (no smoothing)
                        pointStyle: 'circle',
                        pointRadius: 7,
                        pointHoverRadius: 9,
                        pointBackgroundColor: '#0b5ed7',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        spanGaps: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        valueLabelPlugin: { enabled: true },
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Top 5 Disease Probabilities',
                            color: '#374151',
                            font: { size: 16, weight: '600' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            suggestedMin: suggestedMin,
                            suggestedMax: suggestedMax,
                            ticks: {
                                callback: function (v) { return v + '%'; },
                                color: '#374151',
                                font: { size: 12 }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.08)',
                                drawBorder: false
                            }
                        },
                        x: {
                            ticks: {
                                color: '#374151',
                                font: { size: 12 }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.06)',
                                drawOnChartArea: false
                            }
                        }
                    },
                    layout: {
                        padding: { top: 6, right: 6, bottom: 6, left: 6 }
                    },
                    interaction: { mode: 'nearest', axis: 'x', intersect: true }
                },
                plugins: [valueLabelPlugin]
            });

            // Save instance so we can destroy later
            canvas._chartInstance = chart;
        }

        // Expand the chart to a larger view for less-congested display
        function expandChart() {
            const wrapper = document.getElementById('predictionChartWrapper');
            const canvas = document.getElementById('predictionChart');
            const expandBtn = document.getElementById('expandChartBtn');
            const collapseBtn = document.getElementById('collapseChartBtn');
            if (!wrapper || !canvas) return;

            wrapper.style.height = '620px';
            expandBtn.style.display = 'none';
            collapseBtn.style.display = 'inline-block';

            const chart = canvas._chartInstance;
            if (chart) {
                chart.data.datasets[0].pointRadius = 10;
                if (chart.options && chart.options.plugins && chart.options.plugins.title && chart.options.plugins.title.font) {
                    chart.options.plugins.title.font.size = 20;
                }
                chart.update();
            }

            // Scroll into view for the user
            wrapper.scrollIntoView({ behavior: 'smooth' });
        }

        // Collapse the chart back to the normal view
        function collapseChart() {
            const wrapper = document.getElementById('predictionChartWrapper');
            const canvas = document.getElementById('predictionChart');
            const expandBtn = document.getElementById('expandChartBtn');
            const collapseBtn = document.getElementById('collapseChartBtn');
            if (!wrapper || !canvas) return;

            wrapper.style.height = '360px';
            expandBtn.style.display = 'inline-block';
            collapseBtn.style.display = 'none';

            const chart = canvas._chartInstance;
            if (chart) {
                chart.data.datasets[0].pointRadius = 7;
                if (chart.options && chart.options.plugins && chart.options.plugins.title && chart.options.plugins.title.font) {
                    chart.options.plugins.title.font.size = 16;
                }
                chart.update();
            }
        }

        // Initialize
        // Show category modal on first visit to let user choose acute/chronic
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('categoryModal');
            if (modal) modal.style.display = 'flex';
        });

        function selectCategory(cat) {
            selectedCategory = cat;
            const modal = document.getElementById('categoryModal');
            if (modal) modal.style.display = 'none';
            // Load filtered symptoms based on selection
            loadSymptoms();
        }

        // Load default symptoms if user doesn't interact
        setTimeout(() => { if (!selectedCategory) loadSymptoms(); }, 500);
    </script>
</body>

</html>